<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>graph ui</title>
    <style>
      :root {
        --sans-font: -apple-system, BlinkMacSystemFont, "Avenir Next", Avenir,
          "Nimbus Sans L", Roboto, "Noto Sans", "Segoe UI", Arial, Helvetica,
          "Helvetica Neue", sans-serif;
        --bg: #f5f7ff;
        --text: #212121;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          color-scheme: dark;
          --bg: #212121;
          --text: #dcdcdc;
        }
      }

      *, *::before, *::after {
        box-sizing: border-box;
      }

      html {
        font-family: var(--sans-font);
        scroll-behavior: smooth;
      }

      body {
        color: var(--text);
        background-color: var(--bg);
        font-size: 1.15rem;
        line-height: 1.5;
        display: grid;
        grid-template-columns: 1fr min(45rem, 90%) 1fr;
        margin: 0;
      }

      body > * {
        grid-column: 2;
      }

      board-element {
        display: block;
        border: 2px solid gray;
        min-height: 40vh;
        height: 100%;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Graph UI</h1>
      <p>
        this page is based on this <a href="https://zenn.dev/aishift/articles/4649f6af5d175b">article</a>.
      </p>
      <simple-greeting name="sample"></simple-greeting>
      <board-element>

      </board-element>
      <div id="board"></div>
      <!-- <a href="/" >back to home</a> -->
    </main>
    <script type="module">
      import {
        LitElement,
        css,
        html,
        styleMap
      } from 'https://cdn.jsdelivr.net/gh/lit/dist@3/all/lit-all.min.js';

      class SimpleGreeting extends LitElement {
        static properties = {
          name: {},
        };
        // Define scoped styles right with your component, in plain CSS
        static styles = css`
          :host {
            color: blue;
          }
        `;

        constructor() {
          super();
          // Declare reactive properties
          this.name = 'World';
        }

        // Render the UI as a function of component state
        render() {
          return html`<p>Hello, ${this.name}!</p>`;
        }
      }
      customElements.define('simple-greeting', SimpleGreeting);

      class NodeElement extends LitElement {
        static styles = css`
          .node {
            /* for node outline */
            border: solid 1px;
            width: 120px;
            height: 40px;
            border-radius: 6px;
            padding: 8px 16px;

            /* for node content layout */
            display: flex;
            justify-content: center;
            align-items: center;

            cursor: pointer;
          }

          .node-outside {
            display: flex;
            flex-direction: column;
            align-items: center;
          }

          .connector {
            width: 10px;
            height: 10px;
            border: solid 1px;
            border-radius: 50%;
            cursor: pointer;
          }

          .node-wrapper {
            position: absolute;
          }
        `

        static properties = {
          id: { type: String, reflect: true },
          position: { type: Object, reflect: true },
        }

        // attributeChangedCallback(name, oldVal, newVal) {
        //   console.log('attribute change: ', name, newVal)
        //   super.attributeChangedCallback(name, oldVal, newVal)
        // }

        render() {
          const transform = {
            transform: `translate(${this.position.x}px, ${this.position.y}px)`
          }
          return html`
            <div
              class="node-wrapper"
              style=${styleMap(transform)}
              @mousedown=${this._handleMouseDown}
            >
              <div class="node-outside">
                <div class="connector"></div>
                <div class="node">x: ${this.position.x}, y: ${this.position.y}</div>
                <div class="connector" /></div>
              </div>
            </div>
          `
        }

        constructor() {
          super()
          this.position = { x: 0, y: 0 }
        }

        _handleMouseDown(e) {
          const detail = { selectedNodeId: this.id }
          // console.log('from node: ', detail)
          const event = new CustomEvent('nodeselect', {
            detail,
            bubbles: true,
            composed: true,
            cancelable: true,
          })
          this.dispatchEvent(event)
          if (event.defaultPrevented) {
            e.preventDefault()
          }
        }
      }

      customElements.define("node-element", NodeElement);

      class BoardElement extends LitElement {
        static styles = css`
          .board {
            position: relative;
            width: 100%;
            height: 100%;
          }
        `

        constructor() {
          super();
          this.nodes = [
            {
              id: "node1",
              position: { x: 100, y: 100 },
            },
            {
              id: "node2",
              position: { x: 400, y: 100 },
            },
          ]
          this._selectedNodeId = null
        }

        static properties = {
          nodes : { type: Array, reflect: true },
          _selectedNodeId: { state: true }
        }

        // attributeChangedCallback(name, oldVal, newVal) {
        //   console.log('attribute change: ', name, newVal);
        //   super.attributeChangedCallback(name, oldVal, newVal);
        // }

        _onNodeSelect(e) {
          // console.log('mouse down from child: ', e.detail.selectedNodeId, e);
          const id = e.detail.selectedNodeId
          if (typeof id === 'string') {
            this._selectedNodeId = id
          }
        }

        _onMouseUpBoard() {
          // console.log('mouse up: ', this._selectedNodeId);
          this._selectedNodeId = null
        }

        _onMouseMoveBoard(event) {
          // console.log('mouse move: ', this._selectedNodeId);
          if (this._selectedNodeId) {
            const selectedNode = this.nodes.find((node) => node.id === this._selectedNodeId)
            if (!selectedNode) return
            this.nodes = this.nodes.map((node) => {
              return selectedNode.id === node.id ? {
                ...node,
                position: {
                  x: node.position.x + event.movementX,
                  y: node.position.y + event.movementY,
                }
              } : node
            })
          }
        }

        render() {
          return html`
            <div
              class="board"
              @mousemove=${this._onMouseMoveBoard}
              @mouseup=${this._onMouseUpBoard}
              @mouseleave=${this._onMouseUpBoard}
            >
              ${this.nodes.map((node) => (
                html`
                  <node-element
                    key="${node.id}""
                    id="${node.id}""
                    position="${JSON.stringify(node.position)}"
                    @nodeselect=${this._onNodeSelect}
                  />
                `
              ))}
            </div>
          `
        }
      }

      customElements.define("board-element", BoardElement);
    </script>
  </body>
</html>
